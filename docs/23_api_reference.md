# API Reference

The Gradio application exposes several authenticated API endpoints for external automation, webhooks, and monitoring.

All endpoints are accessed via the Gradio client or standard HTTP POST requests to the `/api/{fn_name}` route (depending on Gradio version/configuration, typically via the `gr.Client` SDK).

## Execution Endpoints

### `api_execute_action`

Executes a single action against a specific project. This is the primary entry point for headless automation.

-   **Inputs:**
    -   `project_id` (number): The target project ID.
    -   `action_id` (string): The identifier of the action to execute (e.g., `demo.counter.set`).
    -   `inputs` (json): A dictionary of arguments matching the action's input schema.
    -   `mode` (string): Execution mode (`interactive`, `assisted`, `autonomous`). Defaults to `assisted` for API calls usually.
    -   `confirmed` (boolean): Set to `true` to bypass confirmation gates for high-risk actions (implies the API caller has authorization).

-   **Output:**
    -   `ExecutionResult` (json): The structured result containing status, message, and state diffs.

### `api_execute_plan`

Executes a multi-step plan sequentially. Stops on the first failure.

-   **Inputs:**
    -   `project_id` (number): The target project ID.
    -   `plan` (json): The `ExecutionPlan` object (see schema).
    -   `mode` (string): Execution mode.

-   **Output:**
    -   `list[ExecutionResult]` (json): Results for all executed steps.

### `api_get_registry`

Returns the current Action and Component registries. Used by clients for discovery.

-   **Inputs:**
    -   `project_id` (number): The target project ID.

-   **Output:**
    -   `JSON`: Object containing `components` and `actions` declarations.

### `api_revert_snapshot`

Reverts the project state to a specific snapshot. This is a destructive operation that creates a new execution record of type `revert`.

-   **Inputs:**
    -   `project_id` (number): The target project ID.
    -   `snapshot_id` (string): The target snapshot to return to.

-   **Output:**
    -   `ExecutionResult` (json): Result of the revert operation.

### `api_simulate_intent` / `api_simulate_plan`

Predicts the outcome of an action or plan without committing changes.

-   **Inputs**: Same as `api_execute_action` / `api_execute_plan`.
-   **Output**: Results marked with `simulated: true`.

---

## Security & Authentication

All API endpoints require authentication.

### Authentication Methods
1.  **Session Cookie**: (Browser-based) Gradio automatically handles cookies for the UI.
2.  **Bearer Token**: (Headless) Provide a `Authorization: Bearer <API_TOKEN>` header. Tokens can be generated by Admins in the User Management panel.

### CORS
By default, CORS is restricted. For cross-origin automation, configure `GRADIO_ALLOWED_ORIGINS` in the [Configuration Reference](24_configuration.md).

---

## Observability Endpoints

### `api_get_audit_log`

Retrieves the recent execution history for a project.

-   **Inputs:**
    -   `project_id` (number): The target project ID.
    -   `limit` (number): Maximum number of records to return (default 100).

-   **Output:**
    -   `list[ExecutionResult]` (json): A list of past execution records.

### `api_budget_forecast`

Returns budget usage stats and exhaustion predictions for a project.

-   **Inputs:**
    -   `project_id` (number): The target project ID.

-   **Output:**
    -   `JSON`:
        ```json
        {
          "status": "ok",
          "burn_rate_per_hour": 12.5,
          "estimated_exhaustion_at": "2023-10-27T14:00:00Z"
        }
        ```

### `api_org_rollup`

Provides a summary of all projects the authenticated user has access to.

-   **Inputs:**
    -   *(None)*

-   **Output:**
    -   `JSON`: A dictionary mapping project names to their budget/execution usage stats.

---

## Configuration & Management Endpoints (Admin Only)

These endpoints allow programmatic configuration of the system.

### `api_manage_webhook`

Create, update, or delete webhooks.

-   **Inputs:**
    -   `op` (string): `create` | `update` | `delete`
    -   `webhook_id` (number, optional): Required for update/delete.
    -   `config` (json): Payload matching the Webhook schema (project_id, action_id, secret, template).

### `api_manage_schedule`

Create, update, or delete scheduled jobs.

-   **Inputs:**
    -   `op` (string): `create` | `update` | `delete`
    -   `schedule_id` (number, optional): Required for update/delete.
    -   `config` (json): Payload matching the Schedule schema (cron, action_id, inputs).

### `api_manage_project`

Global management of the project lifecycle.

-   **Inputs:**
    -   `op` (string): `create` | `archive` | `purge`
    -   `name` (string): Required for create.
    -   `project_id` (number, optional): Required for archive/purge.

### `api_manage_membership`

Manage which users belong to which projects and their roles.

-   **Inputs:**
    -   `op` (string): `add` | `remove` | `update_role`
    -   `project_id` (number)
    -   `username` (string)
    -   `role` (string): `viewer` | `operator` | `admin`

### `api_update_project_policy`

Updates the limits and budgets for a specific project.

-   **Inputs:**
    -   `project_id` (number)
    -   `policy` (json): Payload matching the `example-project.yaml` structure.

---

## Webhooks

(Note: Webhook verification logic is internal, but `api_webhook_execute` handles signed payloads.)

-   **Payload**: Standard JSON payload signed with the webhook secret.
-   **Function**: Maps the payload to an action execution via a template.
